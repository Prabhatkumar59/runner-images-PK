name: Test Windows 2022 Image Generation

on: [push, pull_request]

jobs:
  generate-windows22:
    runs-on: windows-2022

    steps:
      - name: Checkout runner-images repo
        uses: actions/checkout@v4

      - name: Azure Login (Managed Identity)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}       # User-assigned MI client ID
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          auth-type: IDENTITY                              # âœ… Explicitly specify Managed Identity

      - name: Generate Windows 2022 Image
        shell: pwsh
        run: |
          $env:VNET_RESOURCE_GROUP = '<your-network-rg>'
          $env:VNET_NAME = '<your-vnet-name>'
          $env:VNET_SUBNET = '<your-subnet-name>'

          Import-Module ./helpers/GenerateResourcesAndImage.ps1

          $CreateImageParams = @{
            ImageType = 'windows2022'
            SubscriptionId = '${{ secrets.AZURE_SUBSCRIPTION_ID }}'
            ResourceGroupName = '<your-resource-group>'
            AzureLocation = 'eastus'
            AzureClientId = 'placeholder'
            AzureClientSecret = 'placeholder'
            AzureTenantId = 'placeholder'
            OnError = 'Continue'
            Tags = @{
              ExcludeMdeAutoProvisioning = $true
            }
          }

          GenerateResourcesAndImage @CreateImageParams
