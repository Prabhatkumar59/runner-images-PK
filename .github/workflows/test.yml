name: Test GenerateResourcesAndImage

on:[push, pull_request]
jobs:
  generate-image:
    runs-on: windows-2022

    steps:
      - name: Checkout runner-images repo
        uses: actions/checkout@v4

      - name: Set up Azure CLI
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Generate Image
        shell: pwsh
        run: |
          $env:VNET_RESOURCE_GROUP = '<your-network-rg>'
          $env:VNET_NAME = '<your-vnet-name>'
          $env:VNET_SUBNET = '<your-subnet-name>'

          Import-Module ./helpers/GenerateResourcesAndImage.ps1

          $CreateImageParams = @{
            ImageType = 'ubuntu2204'   # adjust as needed
            SubscriptionId = '${{ secrets.AZURE_SUBSCRIPTION_ID }}'
            ResourceGroupName = '<your-resource-group>'
            AzureLocation = 'eastus'   # or your region
            AzureClientId = 'placeholder'
            AzureClientSecret = 'placeholder'
            AzureTenantId = 'placeholder'
            OnError = 'Continue'
            Tags = @{
              ExcludeMdeAutoProvisioning = $true
            }
          }

          GenerateResourcesAndImage @CreateImageParams
